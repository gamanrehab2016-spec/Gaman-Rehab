<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Gaman Rehabilitation Center</title>
    <!-- Favicon for browser tab -->
    <link rel="icon" href="images/Gaman Rehabilitation Center logo.png" type="image/png">
    <link rel="shortcut icon" href="images/Gaman Rehabilitation Center logo.png" type="image/png">
    <link rel="apple-touch-icon" href="images/Gaman Rehabilitation Center logo.png">
    <style>
        /* Dashboard styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .dashboard-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        /* Header styles */
        .dashboard-header {
            background-color: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-left {
            display: flex;
            align-items: center;
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .header-logo {
            width: 40px;
            height: 40px;
            margin-right: 10px;
            object-fit: contain;
        }
        
        .logo-text {
            display: flex;
            flex-direction: column;
        }
        
        .logo-gaman {
            color: #f97316; /* Custom orange */
            font-weight: 700;
            font-size: 20px;
            line-height: 1.2;
        }
        
        .logo-rehabilitation {
            color: #4d7c0f; /* Custom green */
            font-size: 12px;
            font-weight: 500;
        }
        
        .header-title {
            margin-left: 20px;
            padding-left: 20px;
            border-left: 1px solid #e5e7eb;
            font-size: 18px;
            font-weight: 600;
        }
        
        .logout-btn {
            background-color: #f3f4f6;
            color: #4b5563;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .logout-btn:hover {
            background-color: #e5e7eb;
            color: #1f2937;
        }
        
        /* Main content */
        .dashboard-content {
            padding: 30px;
            flex: 1;
        }
        
        .content-header {
            margin-bottom: 20px;
        }
        
        .content-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .content-subtitle {
            color: #6b7280;
            font-size: 16px;
        }
        
        /* Dashboard grid layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        
        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        /* Calendar styles */
        .calendar-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 20px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .calendar-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .calendar-nav {
            display: flex;
            gap: 10px;
        }
        
        .calendar-nav-btn {
            background-color: #f97316;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .calendar-nav-btn:hover {
            background-color: #ea580c;
        }
        
        .calendar-month {
            font-weight: 600;
            font-size: 16px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .calendar-day-header {
            text-align: center;
            font-weight: 500;
            font-size: 14px;
            color: #6b7280;
            padding: 5px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 5px;
            text-align: center;
            position: relative;
        }
        
        .calendar-day.other-month {
            background-color: #f9fafb;
            color: #9ca3af;
        }
        
        .calendar-day.today {
            background-color: #fff7ed;
            border-color: #f97316;
        }
        
        .calendar-day.has-events::after {
            content: '';
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #f97316;
        }
        
        .calendar-day.selected {
            background-color: #ffedd5;
            border-color: #f97316;
        }
        
        .calendar-day-number {
            font-weight: 500;
        }
        
        /* Appointments list */
        .appointments-wrapper {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        
        .appointment-card {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            background-color: white;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #f97316;
        }
        
        .appointment-card:hover {
            background-color: #f9fafb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .appointment-card:last-child {
            border-bottom: none;
        }
        
        .appointment-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 10px;
        }
        
        .appointment-name {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            flex: 1;
        }
        
        .appointment-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }
        
        .appointment-date {
            font-size: 14px;
            color: #4b5563;
            background-color: #e5e7eb;
            padding: 4px 10px;
            border-radius: 20px;
        }
        
        .appointment-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .detail-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 2px;
        }
        
        .detail-value {
            font-size: 14px;
            color: #1f2937;
            font-weight: 500;
        }
        
        .appointment-notes {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #e5e7eb;
        }
        
        .notes-label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
        }
        
        .notes-content {
            font-size: 14px;
            color: #4b5563;
            line-height: 1.5;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        
        .empty-icon {
            font-size: 40px;
            margin-bottom: 20px;
            color: #d1d5db;
        }
        
        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #4b5563;
        }
        
        .empty-description {
            font-size: 14px;
            max-width: 400px;
            margin: 0 auto;
        }
        
        /* Loading state */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid #f97316;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 16px;
            color: #6b7280;
        }
        
        /* Status indicators */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        
        .status-completed {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }
        
        .status-cancelled {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        .status-rescheduled {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        
        /* Status update controls */
        .status-update-container {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .status-dropdown {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 120px;
        }
        
        .status-dropdown:hover {
            border-color: #9ca3af;
            background-color: #f9fafb;
        }
        
        .status-dropdown:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }
        
        .update-button {
            background-color: #f97316;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .update-button:hover {
            background-color: #ea580c;
        }
        
        .update-button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        
        .update-feedback {
            font-size: 11px;
            font-weight: 500;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .update-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .update-error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .status-controls-label {
            font-size: 11px;
            color: #6b7280;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* ==============================================
           MULTI-COLLECTION STYLES
           ============================================== */
        
        .collection-tabs {
            display: flex;
            gap: 2px;
            margin: 20px 0;
            background: #f8fafc;
            padding: 4px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
        
        .tab-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: #64748b;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            position: relative;
            flex: 1;
            justify-content: center;
        }
        
        .tab-btn:hover {
            background: #e2e8f0;
            color: #475569;
        }
        
        .tab-btn.active {
            background: white;
            color: #1e293b;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        
        .tab-icon {
            font-size: 16px;
        }
        
        .tab-count {
            background: #e2e8f0;
            color: #64748b;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }
        
        .tab-btn.active .tab-count {
            background: #dbeafe;
            color: #1d4ed8;
        }
        
        .collection-section {
            display: none;
        }
        
        .collection-section.active {
            display: block;
        }
        
        .collection-header {
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            text-align: center;
        }
        
        .collection-header h3 {
            margin: 0 0 8px 0;
            font-size: 24px;
            font-weight: 600;
        }
        
        .collection-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .collections-wrapper {
            min-height: 400px;
        }
        
        .data-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        /* ==============================================
           DATA CARD STYLES
           ============================================== */
        
        .data-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
            overflow: hidden;
        }
        
        .data-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transform: translateY(-1px);
        }
        
        .data-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 20px 20px 16px 20px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .data-card-title {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .data-icon {
            font-size: 20px;
            padding: 8px;
            background: #f8fafc;
            border-radius: 8px;
        }
        
        .data-title-text h4 {
            margin: 0 0 4px 0;
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .data-subtitle {
            margin: 0;
            font-size: 14px;
            color: #64748b;
        }
        
        .data-card-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }
        
        .status-select {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }
        
        .status-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .update-button {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s ease;
            min-width: 70px;
        }
        
        .update-button:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .update-button:active {
            transform: translateY(0);
        }
        
        .update-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .update-feedback {
            font-size: 11px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 8px;
            display: none;
        }
        
        .update-feedback.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        
        .update-feedback.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .update-feedback.info {
            background: #eff6ff;
            color: #2563eb;
            border: 1px solid #bfdbfe;
        }
        
        .status-controls {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .data-card-content {
            padding: 16px 20px;
        }
        
        .data-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .data-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .data-field label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-field span {
            font-size: 14px;
            color: #334155;
            font-weight: 500;
        }
        
        .data-card-message {
            margin-top: 16px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        
        .data-card-message strong {
            display: block;
            margin-bottom: 8px;
            color: #1e293b;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-card-message p {
            margin: 0;
            color: #475569;
            line-height: 1.6;
        }
        
        .data-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: #f8fafc;
            border-top: 1px solid #f1f5f9;
        }
        
        .data-created, .data-type {
            font-size: 12px;
            color: #64748b;
        }
        
        .data-type {
            background: #e2e8f0;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-header {
                padding: 15px 20px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .header-title {
                margin-left: 0;
                padding-left: 0;
                border-left: none;
            }
            
            .dashboard-content {
                padding: 20px;
            }
            
            .appointment-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .appointment-meta {
                align-items: flex-start;
                flex-direction: row;
                gap: 10px;
                flex-wrap: wrap;
            }
            
            .token-number {
                font-size: 11px;
                padding: 3px 8px;
            }
            
            .appointment-details {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        
        /* Export Button Styles */
        .export-section {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .export-label {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }
        
        .export-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        
        .export-btn.excel {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            box-shadow: 0 2px 4px rgba(34, 197, 94, 0.2);
        }
        
        .export-btn.excel:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(34, 197, 94, 0.3);
        }
        
        .export-btn.csv {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }
        
        .export-btn.csv:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }
        
        .export-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .export-btn .icon {
            font-size: 16px;
        }
        
        /* Export controls for each collection */
        .export-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .export-label {
            font-weight: 600;
            color: #6b7280;
            font-size: 14px;
        }
        
        /* Single document export buttons */
        .export-single-btn {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 4px 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 4px;
        }
        
        .export-single-btn:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
        }
        
        .export-single-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* Card footer layout */
        .data-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #e5e7eb;
            border-radius: 0 0 8px 8px;
        }
        
        .footer-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .footer-right {
            display: flex;
            gap: 4px;
        }
        
        @media (max-width: 768px) {
            .export-section {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .export-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
    
    <!-- SheetJS library for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Admin filter styles and scripts -->
    <link rel="stylesheet" href="admin-filters.css">
    <link rel="stylesheet" href="admin-reset.css">
    <script src="admin-filters.js" defer></script>
    <script src="admin-reset-helper.js" defer></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Dashboard Header -->
        <header class="dashboard-header">
            <div class="header-left">
                <div class="logo-container">
                    <img src="images/Gaman Rehabilitation Center logo.png" alt="Gaman Logo" class="header-logo">
                    <div class="logo-text">
                        <span class="logo-gaman">Gaman</span>
                        <span class="logo-rehabilitation">Rehabilitation Center</span>
                    </div>
                </div>
                <h1 class="header-title">Admin ‚Äî Appointments</h1>
            </div>
            
            <button id="logoutButton" class="logout-btn" onclick="handleLogoutClick()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Sign Out
            </button>
        </header>
        
        <!-- Dashboard Content -->
        <main class="dashboard-content">
            <div class="content-header">
                <h2 class="content-title">Appointments Dashboard</h2>
                <p class="content-subtitle">View and manage patient appointments</p>
                
            </div>
            
            <!-- Statistics Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border-left: 4px solid #f97316;">
                    <h4 style="color: #6b7280; font-size: 14px; margin-bottom: 8px;">Total Records</h4>
                    <p id="totalAppointments" style="font-size: 28px; font-weight: 700; color: #1f2937; margin: 0;">-</p>
                </div>
                <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border-left: 4px solid #22c55e;">
                    <h4 style="color: #6b7280; font-size: 14px; margin-bottom: 8px;">Today's Entries</h4>
                    <p id="todayAppointments" style="font-size: 28px; font-weight: 700; color: #1f2937; margin: 0;">-</p>
                </div>
                <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border-left: 4px solid #3b82f6;">
                    <h4 style="color: #6b7280; font-size: 14px; margin-bottom: 8px;">This Month</h4>
                    <p id="monthAppointments" style="font-size: 28px; font-weight: 700; color: #1f2937; margin: 0;">-</p>
                </div>
                <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border-left: 4px solid #8b5cf6;">
                    <h4 style="color: #6b7280; font-size: 14px; margin-bottom: 8px;">Pending</h4>
                    <p id="pendingAppointments" style="font-size: 28px; font-weight: 700; color: #1f2937; margin: 0;">-</p>
                </div>
            </div>
            
            <!-- Export Data Section -->
            <div class="export-section">
                <span class="export-label">üìä Export Appointments:</span>
                <button class="export-btn" data-collection="appointments" data-format="xlsx" id="exportAppointmentsExcel">
                    <span class="icon">üìä</span>
                    Download Excel
                </button>
                <button class="export-btn" data-collection="appointments" data-format="csv" id="exportAppointmentsCSV">
                    <span class="icon">üìÑ</span>
                    Download CSV
                </button>
            </div>
            
            <!-- Collection Tabs -->
            <div class="collection-tabs">
                <button class="tab-btn active" onclick="switchCollection('appointments')" id="appointmentsTab">
                    <span class="tab-icon">üìÖ</span> Appointments
                    <span class="tab-count" id="appointmentsCount">0</span>
                </button>
                <button class="tab-btn" onclick="switchCollection('visits')" id="visitsTab">
                    <span class="tab-icon">üè•</span> Visits
                    <span class="tab-count" id="visitsCount">0</span>
                </button>
                <button class="tab-btn" onclick="switchCollection('callbacks')" id="callbacksTab">
                    <span class="tab-icon">üìû</span> Callbacks
                    <span class="tab-count" id="callbacksCount">0</span>
                </button>
                <button class="tab-btn" onclick="switchCollection('consultations')" id="consultationsTab">
                    <span class="tab-icon">üí¨</span> Consultations
                    <span class="tab-count" id="consultationsCount">0</span>
                </button>
            </div>
            
            <div class="dashboard-grid">
                <!-- Collections Content Column -->
                <div class="collections-wrapper">
                    <!-- Appointments Section -->
                    <div id="appointmentsSection" class="collection-section active">
                        <div class="collection-header">
                            <h3>üìÖ Appointments Management</h3>
                            <p>Manage patient appointment bookings</p>
                        </div>
                        
                        <!-- Loading State -->
                        <div id="appointmentsLoading" class="loading-state">
                            <div class="loading-spinner"></div>
                            <p class="loading-text">Loading appointments...</p>
                        </div>
                        
                        <!-- Empty State -->
                        <div id="appointmentsEmpty" class="empty-state" style="display: none;">
                            <div class="empty-icon">üìÖ</div>
                            <h3 class="empty-title">No appointments yet</h3>
                            <p class="empty-description">
                                Appointments will appear here when patients book them from the website.
                            </p>
                        </div>
                        
                        <!-- Appointments List -->
                        <div id="appointmentsList" class="data-list"></div>
                    </div>

                    <!-- Visits Section -->
                    <div id="visitsSection" class="collection-section" style="display: none;">
                        <div class="collection-header">
                            <h3>üè• Visit Requests Management</h3>
                            <p>Manage center visit requests</p>
                        </div>
                        
                        <!-- Export Buttons for Visits -->
                        <div class="export-controls">
                            <span class="export-label">üìä Export Visits:</span>
                            <button class="export-btn" data-collection="visits" data-format="xlsx">
                                <span class="icon">üìä</span>
                                Download Excel
                            </button>
                            <button class="export-btn" data-collection="visits" data-format="csv">
                                <span class="icon">üìÑ</span>
                                Download CSV
                            </button>
                        </div>
                        
                        <!-- Loading State -->
                        <div id="visitsLoading" class="loading-state">
                            <div class="loading-spinner"></div>
                            <p class="loading-text">Loading visits...</p>
                        </div>
                        
                        <!-- Empty State -->
                        <div id="visitsEmpty" class="empty-state" style="display: none;">
                            <div class="empty-icon">üè•</div>
                            <h3 class="empty-title">No visit requests yet</h3>
                            <p class="empty-description">
                                Visit requests will appear here when submitted from the website.
                            </p>
                        </div>
                        
                        <!-- Visits List -->
                        <div id="visitsList" class="data-list"></div>
                    </div>

                    <!-- Callbacks Section -->
                    <div id="callbacksSection" class="collection-section" style="display: none;">
                        <div class="collection-header">
                            <h3>üìû Callback Requests Management</h3>
                            <p>Manage callback requests</p>
                        </div>
                        
                        <!-- Export Buttons for Callbacks -->
                        <div class="export-controls">
                            <span class="export-label">üìä Export Callbacks:</span>
                            <button class="export-btn" data-collection="callbacks" data-format="xlsx">
                                <span class="icon">üìä</span>
                                Download Excel
                            </button>
                            <button class="export-btn" data-collection="callbacks" data-format="csv">
                                <span class="icon">üìÑ</span>
                                Download CSV
                            </button>
                        </div>
                        
                        <!-- Loading State -->
                        <div id="callbacksLoading" class="loading-state">
                            <div class="loading-spinner"></div>
                            <p class="loading-text">Loading callbacks...</p>
                        </div>
                        
                        <!-- Empty State -->
                        <div id="callbacksEmpty" class="empty-state" style="display: none;">
                            <div class="empty-icon">üìû</div>
                            <h3 class="empty-title">No callback requests yet</h3>
                            <p class="empty-description">
                                Callback requests will appear here when submitted from the website.
                            </p>
                        </div>
                        
                        <!-- Callbacks List -->
                        <div id="callbacksList" class="data-list"></div>
                    </div>

                    <!-- Consultations Section -->
                    <div id="consultationsSection" class="collection-section" style="display: none;">
                        <div class="collection-header">
                            <h3>üí¨ Consultation Requests Management</h3>
                            <p>Manage consultation requests</p>
                        </div>
                        
                        <!-- Export Buttons for Consultations -->
                        <div class="export-controls">
                            <span class="export-label">üìä Export Consultations:</span>
                            <button class="export-btn" data-collection="consultations" data-format="xlsx">
                                <span class="icon">üìä</span>
                                Download Excel
                            </button>
                            <button class="export-btn" data-collection="consultations" data-format="csv">
                                <span class="icon">üìÑ</span>
                                Download CSV
                            </button>
                        </div>
                        
                        <!-- Loading State -->
                        <div id="consultationsLoading" class="loading-state">
                            <div class="loading-spinner"></div>
                            <p class="loading-text">Loading consultations...</p>
                        </div>
                        
                        <!-- Empty State -->
                        <div id="consultationsEmpty" class="empty-state" style="display: none;">
                            <div class="empty-icon">üí¨</div>
                            <h3 class="empty-title">No consultation requests yet</h3>
                            <p class="empty-description">
                                Consultation requests will appear here when submitted from the website.
                            </p>
                        </div>
                        
                        <!-- Consultations List -->
                        <div id="consultationsList" class="data-list"></div>
                    </div>
                    
                    <!-- Legacy support -->
                    <div id="appointmentsContainer" style="display: none;"></div>
                </div>
                
                <!-- Calendar Column -->
                <div class="calendar-container">
                    <div class="calendar-header">
                        <h3 class="calendar-title">Appointment Calendar</h3>
                        <div class="calendar-nav">
                            <button id="prevMonthBtn" class="calendar-nav-btn">Previous</button>
                            <span id="currentMonth" class="calendar-month">September 2025</span>
                            <button id="nextMonthBtn" class="calendar-nav-btn">Next</button>
                        </div>
                    </div>
                    <div id="calendarGrid" class="calendar-grid">
                        <!-- Calendar will be generated by JavaScript -->
                    </div>
                    <div style="margin-top: 15px; text-align: center;">
                        <button id="clearFilterBtn" style="background-color: #e5e7eb; color: #4b5563; border: none; border-radius: 4px; padding: 8px 15px; cursor: pointer; font-size: 14px;">Clear Date Filter</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="firebase-diagnostic.js"></script>
    <script type="module">
        // Import Firebase services
        import { 
            auth, 
            onAuthStateChanged, 
            signOut,
            db,
            collection,
            query,
            orderBy,
            onSnapshot,
            addDoc,
            updateDoc,
            doc,
            getDoc,
            getDocs,
            serverTimestamp
        } from './firebase.js';
        
        // Add diagnostic script
        function checkTokensInFirebase() {
            console.log('üîç Checking for tokens in Firebase...');
            
            const collections = ['appointments', 'visits', 'callbacks', 'consultations'];
            
            collections.forEach(async (collectionName) => {
                try {
                    const q = query(collection(db, collectionName), orderBy('createdAt', 'desc'));
                    const snapshot = await getDocs(q);
                    
                    console.log(`\nüìã ${collectionName} - Found ${snapshot.size} documents:`);
                    snapshot.forEach((doc, index) => {
                        if (index < 5) { // Only show first 5
                            const data = doc.data();
                            console.log(`   ${index + 1}. Document ${doc.id}:`);
                            if (data.token || data.tokenNumber || data.tokenDisplay) {
                                console.log(`      üé´ HAS TOKENS:`, {
                                    token: data.token,
                                    tokenNumber: data.tokenNumber,
                                    tokenDisplay: data.tokenDisplay
                                });
                            } else {
                                console.log(`      ‚úÖ No tokens found`);
                            }
                            console.log(`      üìù Name: ${data.name}, Date: ${data.date || data.preferredDate}`);
                        }
                    });
                    
                } catch (error) {
                    console.error(`‚ùå Error checking ${collectionName}:`, error);
                }
            });
        }
        
        // Run token check after 2 seconds
        setTimeout(checkTokensInFirebase, 2000);
        
        // DOM elements - these will be updated when switching collections
        let currentLoadingState = document.getElementById('appointmentsLoading');
        let currentEmptyState = document.getElementById('appointmentsEmpty');
        let currentDataList = document.getElementById('appointmentsList');
        
        // Variable to store our unsubscribe function
        let unsubscribeFromAppointments = null;
        
        // Store current appointments data for reference
        let currentAppointments = [];
        
        // ==============================================
        // MULTI-COLLECTION VARIABLES
        // ==============================================
        
        // Store all collection data
        let currentVisits = [];
        let currentCallbacks = [];
        let currentConsultations = [];
        
        // Unsubscribe functions for all collections
        let unsubscribeFromVisits = null;
        let unsubscribeFromCallbacks = null;
        let unsubscribeFromConsultations = null;
        
        // Current active collection
        let activeCollection = 'appointments';
        
        // Collection configurations
        const collectionConfigs = {
            appointments: {
                name: 'appointments',
                displayName: 'Appointments',
                icon: 'üìÖ',
                data: () => currentAppointments,
                listElement: 'appointmentsList',
                loadingElement: 'appointmentsLoading',
                emptyElement: 'appointmentsEmpty',
                sectionElement: 'appointmentsSection',
                countElement: 'appointmentsCount'
            },
            visits: {
                name: 'visits',
                displayName: 'Visits',
                icon: 'üè•',
                data: () => currentVisits,
                listElement: 'visitsList',
                loadingElement: 'visitsLoading',
                emptyElement: 'visitsEmpty',
                sectionElement: 'visitsSection',
                countElement: 'visitsCount'
            },
            callbacks: {
                name: 'callbacks',
                displayName: 'Callbacks',
                icon: 'üìû',
                data: () => currentCallbacks,
                listElement: 'callbacksList',
                loadingElement: 'callbacksLoading',
                emptyElement: 'callbacksEmpty',
                sectionElement: 'callbacksSection',
                countElement: 'callbacksCount'
            },
            consultations: {
                name: 'consultations',
                displayName: 'Consultations',
                icon: 'üí¨',
                data: () => currentConsultations,
                listElement: 'consultationsList',
                loadingElement: 'consultationsLoading',
                emptyElement: 'consultationsEmpty',
                sectionElement: 'consultationsSection',
                countElement: 'consultationsCount'
            }
        };
        
        // Calendar variables
        let currentDate = new Date();
        let selectedDate = null;
        
        // Initialize calendar
        function initializeCalendar() {
            renderCalendar(currentDate);
            
            // Add event listeners for calendar navigation
            document.getElementById('prevMonthBtn').addEventListener('click', () => {
                currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
                renderCalendar(currentDate);
            });
            
            document.getElementById('nextMonthBtn').addEventListener('click', () => {
                currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
                renderCalendar(currentDate);
            });
            
            // Add event listener for clear filter button
            document.getElementById('clearFilterBtn').addEventListener('click', resetDataFilters);
            
            // Add today button functionality
            const todayBtn = document.createElement('button');
            todayBtn.textContent = 'Today';
            todayBtn.className = 'calendar-nav-btn';
            todayBtn.style.marginLeft = '10px';
            todayBtn.addEventListener('click', () => {
                currentDate = new Date();
                selectedDate = new Date();
                renderCalendar(currentDate);
                filterDataByDate(selectedDate);
            });
            
            document.getElementById('nextMonthBtn').parentNode.insertBefore(todayBtn, document.getElementById('nextMonthBtn').nextSibling);
        }
        
        // Render calendar for the given month
        function renderCalendar(date) {
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonthElement = document.getElementById('currentMonth');
            
            // Clear existing calendar
            calendarGrid.innerHTML = '';
            
            // Set month name
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            currentMonthElement.textContent = `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
            
            // Add day headers (Sun, Mon, Tue, etc.)
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // Get first day of month and last day
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
            const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
            
            // Get day of week for first day (0-6, 0 is Sunday)
            const firstDayOfWeek = firstDay.getDay();
            
            // Generate previous month's days
            const prevMonthLastDay = new Date(date.getFullYear(), date.getMonth(), 0).getDate();
            for (let i = 0; i < firstDayOfWeek; i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.innerHTML = `<span class="calendar-day-number">${prevMonthLastDay - firstDayOfWeek + i + 1}</span>`;
                calendarGrid.appendChild(day);
            }
            
            // Generate current month's days
            const today = new Date();
            for (let i = 1; i <= lastDay.getDate(); i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day';
                
                // Check if this is today
                if (date.getMonth() === today.getMonth() && 
                    date.getFullYear() === today.getFullYear() && 
                    i === today.getDate()) {
                    day.classList.add('today');
                }
                
                // Check if this day has any data from all collections
                const dayDate = new Date(date.getFullYear(), date.getMonth(), i);
                const hasEvents = checkDayHasEvents(dayDate);
                
                if (hasEvents) {
                    day.classList.add('has-events');
                }
                
                // Check if this is the selected date
                if (selectedDate && 
                    date.getMonth() === selectedDate.getMonth() && 
                    date.getFullYear() === selectedDate.getFullYear() && 
                    i === selectedDate.getDate()) {
                    day.classList.add('selected');
                }
                
                day.innerHTML = `<span class="calendar-day-number">${i}</span>`;
                
                // Add click event to show data for this day
                day.addEventListener('click', () => {
                    // Update selected date
                    selectedDate = new Date(date.getFullYear(), date.getMonth(), i);
                    
                    // Update calendar to show selection
                    document.querySelectorAll('.calendar-day.selected').forEach(el => {
                        el.classList.remove('selected');
                    });
                    day.classList.add('selected');
                    
                    // Filter data for this day based on active collection
                    filterDataByDate(selectedDate);
                });
                
                calendarGrid.appendChild(day);
            }
            
            // Fill remaining grid with next month's days
            const remainingDays = 42 - (firstDayOfWeek + lastDay.getDate()); // 6 rows of 7 days
            for (let i = 1; i <= remainingDays; i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.innerHTML = `<span class="calendar-day-number">${i}</span>`;
                calendarGrid.appendChild(day);
            }
        }
        
        // Check if a day has events from any collection
        function checkDayHasEvents(dayDate) {
            // Check appointments
            const hasAppointments = currentAppointments.some(item => {
                const dateValue = item.date || item.preferredDate;
                if (!dateValue) return false;
                const itemDate = new Date(dateValue);
                if (isNaN(itemDate.getTime())) return false;
                return itemDate.getDate() === dayDate.getDate() && 
                       itemDate.getMonth() === dayDate.getMonth() && 
                       itemDate.getFullYear() === dayDate.getFullYear();
            });
            
            // Check visits
            const hasVisits = currentVisits.some(item => {
                const dateValue = item.date || item.preferredDate;
                if (!dateValue) return false;
                const itemDate = new Date(dateValue);
                if (isNaN(itemDate.getTime())) return false;
                return itemDate.getDate() === dayDate.getDate() && 
                       itemDate.getMonth() === dayDate.getMonth() && 
                       itemDate.getFullYear() === dayDate.getFullYear();
            });
            
            // Check callbacks (use createdAt timestamp since callbacks don't have user-selected dates)
            const hasCallbacks = currentCallbacks.some(item => {
                let itemDate;
                if (item.createdAt && item.createdAt.toDate) {
                    itemDate = item.createdAt.toDate();
                } else if (item.timestamp) {
                    itemDate = new Date(item.timestamp);
                } else if (item.createdAt) {
                    itemDate = new Date(item.createdAt);
                } else {
                    return false; // No valid date found
                }
                
                if (isNaN(itemDate.getTime())) return false;
                
                return itemDate.getDate() === dayDate.getDate() && 
                       itemDate.getMonth() === dayDate.getMonth() && 
                       itemDate.getFullYear() === dayDate.getFullYear();
            });
            
            // Check consultations
            const hasConsultations = currentConsultations.some(item => {
                const dateValue = item.date || item.preferredDate;
                if (!dateValue) return false;
                const itemDate = new Date(dateValue);
                if (isNaN(itemDate.getTime())) return false;
                return itemDate.getDate() === dayDate.getDate() && 
                       itemDate.getMonth() === dayDate.getMonth() && 
                       itemDate.getFullYear() === dayDate.getFullYear();
            });
            
            return hasAppointments || hasVisits || hasCallbacks || hasConsultations;
        }
        
        // Filter data by selected date based on active collection
        function filterDataByDate(date) {
            // If no date is selected, show all data
            if (!date) {
                showAllDataForActiveCollection();
                return;
            }
            
            const config = collectionConfigs[activeCollection];
            if (!config) return;
            
            const currentData = config.data();
            
            // Filter data for the selected date
            const filteredData = currentData.filter(item => {
                let itemDate;
                
                // Handle different date field structures for different collections
                if (activeCollection === 'callbacks') {
                    // Callbacks use createdAt timestamp instead of user-selected date
                    if (item.createdAt && item.createdAt.toDate) {
                        itemDate = item.createdAt.toDate();
                    } else if (item.timestamp) {
                        itemDate = new Date(item.timestamp);
                    } else if (item.createdAt) {
                        itemDate = new Date(item.createdAt);
                    } else {
                        return false; // No valid date found
                    }
                } else {
                    // Other collections (appointments, visits, consultations) use date or preferredDate
                    const dateValue = item.date || item.preferredDate;
                    if (!dateValue) {
                        return false; // No date field found
                    }
                    itemDate = new Date(dateValue);
                }
                
                // Validate the date is valid
                if (isNaN(itemDate.getTime())) {
                    console.warn(`Invalid date found in ${activeCollection}:`, item);
                    return false;
                }
                
                return itemDate.getDate() === date.getDate() && 
                       itemDate.getMonth() === date.getMonth() && 
                       itemDate.getFullYear() === date.getFullYear();
            });
            
            // Render filtered data
            const listElement = document.getElementById(config.listElement);
            if (listElement) {
                renderCollectionData(activeCollection, filteredData, listElement);
            }
            
            // Update header to show filtering is active
            const contentTitle = document.querySelector('.content-title');
            const contentSubtitle = document.querySelector('.content-subtitle');
            
            if (filteredData.length > 0) {
                contentTitle.textContent = `${config.displayName} for ${date.toLocaleDateString()}`;
                contentSubtitle.textContent = `Showing ${filteredData.length} ${config.displayName.toLowerCase()} for this date`;
            } else {
                contentTitle.textContent = `No ${config.displayName} for ${date.toLocaleDateString()}`;
                contentSubtitle.textContent = `There are no ${config.displayName.toLowerCase()} scheduled for this date`;
            }
        }
        
        // Show all data for the currently active collection
        function showAllDataForActiveCollection() {
            const config = collectionConfigs[activeCollection];
            if (!config) return;
            
            const currentData = config.data();
            const listElement = document.getElementById(config.listElement);
            
            if (listElement) {
                renderCollectionData(activeCollection, currentData, listElement);
            }
            
            // Reset header
            const contentTitle = document.querySelector('.content-title');
            const contentSubtitle = document.querySelector('.content-subtitle');
            
            contentTitle.textContent = `${config.displayName} Dashboard`;
            contentSubtitle.textContent = `View and manage ${config.displayName.toLowerCase()}`;
        }
        
        // Filter appointments by selected date
        function filterAppointmentsByDate(date) {
            // If no date is selected, show all appointments
            if (!date) {
                renderAppointments(currentAppointments);
                return;
            }
            
            // Filter appointments for the selected date
            const filteredAppointments = currentAppointments.filter(appointment => {
                const appointmentDate = new Date(appointment.date);
                return appointmentDate.getDate() === date.getDate() && 
                       appointmentDate.getMonth() === date.getMonth() && 
                       appointmentDate.getFullYear() === date.getFullYear();
            });
            
            // Render filtered appointments
            renderAppointments(filteredAppointments);
            
            // Update header to show filtering is active
            const contentTitle = document.querySelector('.content-title');
            const contentSubtitle = document.querySelector('.content-subtitle');
            
            if (filteredAppointments.length > 0) {
                contentTitle.textContent = `Appointments for ${date.toLocaleDateString()}`;
                contentSubtitle.textContent = `Showing ${filteredAppointments.length} appointment(s) for this date`;
            } else {
                contentTitle.textContent = `No Appointments for ${date.toLocaleDateString()}`;
                contentSubtitle.textContent = 'There are no appointments scheduled for this date';
            }
        }
        
        // Reset data filters for all collections
        function resetDataFilters() {
            selectedDate = null;
            
            // Clear selected date in calendar
            document.querySelectorAll('.calendar-day.selected').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Show all data for active collection
            showAllDataForActiveCollection();
        }
        
        // Reset appointment filters (legacy function for backward compatibility)
        function resetAppointmentFilters() {
            resetDataFilters();
        }
        
        // ==============================================
        // MULTI-COLLECTION MANAGEMENT FUNCTIONS
        // ==============================================
        
        // Switch between collections
        function switchCollection(collectionName) {
            console.log(`üîÑ Switching to collection: ${collectionName}`);
            
            // Update active collection
            activeCollection = collectionName;
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${collectionName}Tab`).classList.add('active');
            
            // Update sections
            document.querySelectorAll('.collection-section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });
            
            const activeSection = document.getElementById(`${collectionName}Section`);
            if (activeSection) {
                activeSection.classList.add('active');
                activeSection.style.display = 'block';
            }
            
            // Update export buttons to work with current collection
            updateExportButtons(collectionName);
            
            // Clear any date filters and show all data for the new collection
            resetDataFilters();
            
            // Re-render calendar to show events for the new collection
            renderCalendar(currentDate);
            
            console.log(`‚úÖ Switched to ${collectionName} collection`);
        }
        
        // Setup listeners for all collections
        function setupAllCollectionListeners() {
            console.log('ÔøΩ SETTING UP LISTENERS for all collections...');
            
            console.log('üî• Setting up appointments listener...');
            setupAppointmentsListener();
            
            console.log('üî• Setting up visits listener...');
            setupVisitsListener();
            
            console.log('üî• Setting up callbacks listener...');
            setupCallbacksListener();
            
            console.log('üî• Setting up consultations listener...');
            setupConsultationsListener();
            
            console.log('üî• All listeners setup completed');
        }
        
        // Setup visits listener
        function setupVisitsListener() {
            if (unsubscribeFromVisits) {
                unsubscribeFromVisits();
            }
            
            console.log('üìã Setting up visits listener...');
            
            const visitsRef = collection(db, 'visits');
            const visitsQuery = query(visitsRef, orderBy('createdAt', 'desc'));
            
            unsubscribeFromVisits = onSnapshot(visitsQuery, 
                (snapshot) => {
                    console.log(`üè• Visits snapshot received: ${snapshot.size} documents`);
                    
                    const visits = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        visits.push({
                            id: doc.id,
                            ...data,
                            collection: 'visits',
                            status: data.status || 'Pending',
                            formattedDate: data.date || formatDate(data.createdAt)
                        });
                    });
                    
                    currentVisits = visits;
                    updateCollectionDisplay('visits', visits);
                    updateCollectionCount('visits', visits.length);
                    
                    // Update global statistics
                    updateStatistics();
                },
                (error) => {
                    console.error('‚ùå Error getting visits:', error);
                    showCollectionError('visits', error);
                }
            );
        }
        
        // Setup callbacks listener
        function setupCallbacksListener() {
            if (unsubscribeFromCallbacks) {
                unsubscribeFromCallbacks();
            }
            
            console.log('üìû Setting up callbacks listener...');
            
            const callbacksRef = collection(db, 'callbacks');
            const callbacksQuery = query(callbacksRef, orderBy('createdAt', 'desc'));
            
            unsubscribeFromCallbacks = onSnapshot(callbacksQuery, 
                (snapshot) => {
                    console.log(`üìû Callbacks snapshot received: ${snapshot.size} documents`);
                    
                    const callbacks = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        callbacks.push({
                            id: doc.id,
                            ...data,
                            collection: 'callbacks',
                            status: data.status || 'Pending',
                            formattedDate: data.date || formatDate(data.createdAt)
                        });
                    });
                    
                    currentCallbacks = callbacks;
                    updateCollectionDisplay('callbacks', callbacks);
                    updateCollectionCount('callbacks', callbacks.length);
                    
                    // Update global statistics
                    updateStatistics();
                },
                (error) => {
                    console.error('‚ùå Error getting callbacks:', error);
                    showCollectionError('callbacks', error);
                }
            );
        }
        
        // Setup consultations listener
        function setupConsultationsListener() {
            if (unsubscribeFromConsultations) {
                unsubscribeFromConsultations();
            }
            
            console.log('üí¨ Setting up consultations listener...');
            
            const consultationsRef = collection(db, 'consultations');
            const consultationsQuery = query(consultationsRef, orderBy('createdAt', 'desc'));
            
            unsubscribeFromConsultations = onSnapshot(consultationsQuery, 
                (snapshot) => {
                    console.log(`üí¨ Consultations snapshot received: ${snapshot.size} documents`);
                    
                    const consultations = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        consultations.push({
                            id: doc.id,
                            ...data,
                            collection: 'consultations',
                            status: data.status || 'Pending',
                            formattedDate: data.date || formatDate(data.createdAt)
                        });
                    });
                    
                    currentConsultations = consultations;
                    updateCollectionDisplay('consultations', consultations);
                    updateCollectionCount('consultations', consultations.length);
                    
                    // Update global statistics
                    updateStatistics();
                },
                (error) => {
                    console.error('‚ùå Error getting consultations:', error);
                    showCollectionError('consultations', error);
                }
            );
        }
        
        // Update collection display
        function updateCollectionDisplay(collectionName, data) {
            const config = collectionConfigs[collectionName];
            if (!config) return;
            
            const loadingElement = document.getElementById(config.loadingElement);
            const emptyElement = document.getElementById(config.emptyElement);
            const listElement = document.getElementById(config.listElement);
            
            // Hide loading
            if (loadingElement) loadingElement.style.display = 'none';
            
            if (data.length === 0) {
                // Show empty state
                if (emptyElement) emptyElement.style.display = 'block';
                if (listElement) listElement.innerHTML = '';
            } else {
                // Hide empty state and render data
                if (emptyElement) emptyElement.style.display = 'none';
                if (listElement) {
                    renderCollectionData(collectionName, data, listElement);
                }
            }
        }
        
        // Diagnostic function to check current state
        function checkAppointmentState() {
            console.log('üîç DIAGNOSTIC: Checking appointment state...');
            console.log('üîç currentAppointments:', currentAppointments);
            console.log('üîç currentAppointments.length:', currentAppointments ? currentAppointments.length : 'undefined');
            console.log('üîç appointmentsCount element:', document.getElementById('appointmentsCount'));
            console.log('üîç appointmentsCount value:', document.getElementById('appointmentsCount')?.textContent);
            console.log('üîç collectionConfigs.appointments:', collectionConfigs.appointments);
            console.log('üîç Database connection:', db);
            console.log('üîç Auth user:', auth.currentUser);
        }
        
        // Make diagnostic function globally available
        window.checkAppointmentState = checkAppointmentState;
        
        // Test function to manually update counts
        function testCountUpdate() {
            console.log('üß™ Testing count update functionality...');
            updateCollectionCount('appointments', 5);
            updateCollectionCount('visits', 3);
            updateCollectionCount('callbacks', 2);
            updateCollectionCount('consultations', 1);
        }
        
        // Make test function globally available
        window.testCountUpdate = testCountUpdate;
        
        // Update collection count in tab
        function updateCollectionCount(collectionName, count) {
            console.log(`üî¢ Updating ${collectionName} count to: ${count}`);
            const config = collectionConfigs[collectionName];
            if (!config) {
                console.error(`‚ùå No config found for collection: ${collectionName}`);
                return;
            }
            
            console.log(`üî¢ Looking for count element: ${config.countElement}`);
            const countElement = document.getElementById(config.countElement);
            if (countElement) {
                console.log(`üî¢ Found count element, updating textContent from "${countElement.textContent}" to "${count}"`);
                countElement.textContent = count;
                console.log(`‚úÖ Successfully updated ${collectionName} count display`);
            } else {
                console.error(`‚ùå Count element not found: ${config.countElement}`);
            }
        }
        
        // Show collection error
        function showCollectionError(collectionName, error) {
            const config = collectionConfigs[collectionName];
            if (!config) return;
            
            const loadingElement = document.getElementById(config.loadingElement);
            const listElement = document.getElementById(config.listElement);
            
            if (loadingElement) loadingElement.style.display = 'none';
            if (listElement) {
                listElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ùå</div>
                        <h3 class="empty-title">Error loading ${config.displayName.toLowerCase()}</h3>
                        <p class="empty-description">
                            ${error.message}
                        </p>
                    </div>
                `;
            }
        }
        
        // Format date utility
        function formatDate(timestamp) {
            if (!timestamp) return 'No date';
            
            let date;
            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else if (timestamp instanceof Date) {
                date = timestamp;
            } else {
                date = new Date(timestamp);
            }
            
            return date.toLocaleDateString();
        }
        
        // Make functions globally accessible
        window.switchCollection = switchCollection;
        window.updateItemStatusWithFeedback = updateItemStatusWithFeedback;
        
        // Check authentication state with improved persistence handling
        let authInitialized = false;
        let authCheckTimeout;
        
        // Set a timeout to handle auth state loading
        authCheckTimeout = setTimeout(() => {
            if (!authInitialized) {
                console.log('‚ö†Ô∏è Authentication state not loaded within timeout');
                // Check if we have a current user synchronously
                if (auth.currentUser) {
                    console.log('‚úÖ Found current user synchronously:', auth.currentUser.email);
                    authInitialized = true;
                    initializeDashboard(auth.currentUser);
                } else {
                    console.log('‚ùå No user found after timeout, redirecting to login');
                    alert('Session expired. Please login again.');
                    window.location.href = 'admin.html';
                }
            }
        }, 5000); // 5 second timeout
        
        function initializeDashboard(user) {
            console.log('ÔøΩ INITIALIZING DASHBOARD for user:', user.email);
            
            // Set up real-time listeners for all collections
            console.log('üî• Setting up all collection listeners...');
            setupAllCollectionListeners();
            
            // Initialize calendar
            console.log('üî• Initializing calendar...');
            initializeCalendar();
            
            // Setup logout button
            console.log('üî• Setting up logout button...');
            setupLogoutButton();
            
            // Initialize statistics display
            console.log('üî• Initializing statistics...');
            updateStatistics();
            
            // Display user email in header
            const headerTitle = document.querySelector('.header-title');
            if (headerTitle) {
                headerTitle.innerHTML = `Admin ‚Äî Multi-Collection Dashboard <span style="font-size: 12px; font-weight: normal; color: #6b7280; display: block;">${user.email}</span>`;
            }
            
            console.log('üî• Dashboard initialization completed');
        }
        
        // ==============================================
        // STATUS UPDATE FUNCTIONALITY
        // ==============================================
        
        // Initialize dashboard after authentication
        
        onAuthStateChanged(auth, (user) => {
            console.log('üî• Auth state changed. User:', user ? user.email : 'null');
            
            if (authInitialized) {
                console.log('üî• Auth already initialized, skipping');
                return; // Prevent multiple initializations
            }
            
            authInitialized = true;
            clearTimeout(authCheckTimeout);
            
            if (user) {
                // User is authenticated
                console.log('üî• User authenticated via onAuthStateChanged:', user.email);
                console.log('üî• Calling initializeDashboard...');
                initializeDashboard(user);
            } else {
                // No user found
                console.log('üî• No authenticated user found');
                
                // Double-check current user (sometimes onAuthStateChanged fires before persistence is restored)
                setTimeout(() => {
                    if (auth.currentUser) {
                        console.log('‚úÖ Found current user on second check:', auth.currentUser.email);
                        initializeDashboard(auth.currentUser);
                    } else {
                        console.log('üîÑ Redirecting to login page');
                        alert('You need to login first!');
                        window.location.href = 'admin.html';
                    }
                }, 1000);
            }
        });
        
        // ==============================================
        // DEBUG FUNCTIONS FOR AUTHENTICATION
        // ==============================================
        
        // Debug function to check current authentication status
        function checkAuthStatus() {
            console.log('üîç AUTHENTICATION STATUS DEBUG:');
            console.log('Current user:', auth.currentUser);
            console.log('User email:', auth.currentUser?.email);
            console.log('User UID:', auth.currentUser?.uid);
            console.log('Auth initialized:', authInitialized);
            
            if (auth.currentUser) {
                alert(`‚úÖ Currently authenticated as: ${auth.currentUser.email}\nUID: ${auth.currentUser.uid}`);
            } else {
                alert('‚ùå Not authenticated - You need to login again!');
            }
        }
        
        // Function to force re-authentication check
        function forceAuthCheck() {
            console.log('üîÑ Forcing authentication re-check...');
            if (auth.currentUser) {
                console.log('‚úÖ User found, reinitializing dashboard');
                authInitialized = false;
                initializeDashboard(auth.currentUser);
            } else {
                console.log('‚ùå No user found, redirecting to login');
                window.location.href = 'admin.html';
            }
        }
        
        // Make debug functions globally accessible
        window.checkAuthStatus = checkAuthStatus;
        window.forceAuthCheck = forceAuthCheck;
        
        // Set up real-time listener for appointments
        function setupAppointmentsListener() {
            console.log('üöÄ STARTING setupAppointmentsListener function...');
            
            // Clean up any existing listener
            if (unsubscribeFromAppointments) {
                console.log('üßπ Cleaning up existing appointments listener...');
                unsubscribeFromAppointments();
            }
            
            console.log('üî• Setting up appointments listener...');
            console.log('üî• Database object:', db);
            console.log('üî• Auth object:', auth);
            console.log('üî• Current user:', auth.currentUser);
            
            // Create a query against the appointments collection
            const appointmentsRef = collection(db, 'appointments');
            console.log('üî• Collection reference created:', appointmentsRef);
            
            const appointmentsQuery = query(appointmentsRef, orderBy('createdAt', 'desc'));
            console.log('üî• Query created with orderBy createdAt desc');
            
            // Set up a new listener with onSnapshot
            unsubscribeFromAppointments = onSnapshot(appointmentsQuery, 
                (snapshot) => {
                    console.log('üî• APPOINTMENTS SNAPSHOT RECEIVED with', snapshot.size, 'documents');
                    console.log('üî• Snapshot metadata:', snapshot.metadata);
                    console.log('üî• Snapshot empty:', snapshot.empty);
                    
                    // Hide loading state for appointments
                    const appointmentsLoading = document.getElementById('appointmentsLoading');
                    console.log('üî• appointmentsLoading element:', appointmentsLoading);
                    if (appointmentsLoading) {
                        appointmentsLoading.style.display = 'none';
                        console.log('üî• Hidden loading state');
                    }
                    
                    // Process appointments data
                    const appointments = [];
                    snapshot.forEach((doc) => {
                        // Extract the appointment data with ID
                        const data = doc.data();
                        console.log('üî• Processing appointment document:', doc.id, data);
                        appointments.push({
                            id: doc.id,
                            ...data,
                            // Format date for display if needed
                            formattedDate: data.date || 'No date specified'
                        });
                    });
                    
                    console.log('üî• Processed appointments array length:', appointments.length);
                    console.log('üî• Processed appointments data:', appointments);
                    
                    // Store appointments for reference
                    currentAppointments = appointments;
                    
                    // Update appointment count in tab (always update count)
                    updateCollectionCount('appointments', appointments.length);
                    console.log(`üìÖ Updated appointments count: ${appointments.length}`);
                    
                    if (appointments.length === 0) {
                        // Show empty state if no appointments
                        console.log('No appointments found, showing empty state');
                        const appointmentsEmpty = document.getElementById('appointmentsEmpty');
                        if (appointmentsEmpty) appointmentsEmpty.style.display = 'block';
                        
                        const appointmentsList = document.getElementById('appointmentsList');
                        if (appointmentsList) appointmentsList.innerHTML = '';
                        
                        // Update export buttons for empty state
                        updateExportButtonStates([]);
                        return;
                    }
                    
                    // Hide empty state if there are appointments
                    const appointmentsEmpty = document.getElementById('appointmentsEmpty');
                    if (appointmentsEmpty) appointmentsEmpty.style.display = 'none';
                    
                    // Render appointments to both containers (for compatibility)
                    console.log('Rendering appointments to DOM');
                    renderAppointments(appointments);
                },
                (error) => {
                    // Handle errors
                    console.error('üî• ERROR in appointments listener:', error);
                    console.error('üî• Error message:', error.message);
                    console.error('üî• Error code:', error.code);
                    const appointmentsLoading = document.getElementById('appointmentsLoading');
                    if (appointmentsLoading) appointmentsLoading.style.display = 'none';
                    
                    const appointmentsEmpty = document.getElementById('appointmentsEmpty');
                    if (appointmentsEmpty) {
                        appointmentsEmpty.style.display = 'block';
                        appointmentsEmpty.innerHTML = `
                            <div class="empty-icon">‚ùå</div>
                            <h3 class="empty-title">Error loading appointments</h3>
                            <p class="empty-description">
                                There was an error loading the appointments: ${error.message}
                            </p>
                        `;
                    }
                }
            );
        }
        
        // ==============================================
        // UNIVERSAL DATA RENDERING FUNCTIONS
        // ==============================================
        
        // Render data for any collection
        function renderCollectionData(collectionName, data, container) {
            if (!container) return;
            
            console.log(`üé® Rendering ${data.length} items for ${collectionName}`);
            
            if (data.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            const items = data.map(item => createDataCard(item, collectionName)).join('');
            container.innerHTML = items;
            
            // Add event listeners for status updates
            addStatusUpdateListeners(collectionName);
        }
        
        // Create a universal data card
        function createDataCard(item, collectionName) {
            const config = collectionConfigs[collectionName];
            const icon = config ? config.icon : 'üìã';
            
            return `
                <div class="data-card status-${(item.status || 'Pending').toLowerCase()}" data-id="${item.id}" data-collection="${collectionName}">
                    <div class="data-card-header">
                        <div class="data-card-title">
                            <span class="data-icon">${icon}</span>
                            <div class="data-title-text">
                                <h4>${item.name || 'No Name'}</h4>
                                <p class="data-subtitle">
                                    ${getCardSubtitle(item, collectionName)}
                                    <span class="status-badge status-${(item.status || 'Pending').toLowerCase()}">${item.status || 'Pending'}</span>
                                </p>
                            </div>
                        </div>
                        <div class="data-card-status">
                            <div class="status-controls">
                                <select class="status-select" data-id="${item.id}" data-collection="${collectionName}" id="status-${item.id}">
                                    <option value="Pending" ${(item.status || 'Pending') === 'Pending' ? 'selected' : ''}>Pending</option>
                                    <option value="Completed" ${item.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                    <option value="Cancelled" ${item.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                                    <option value="Rescheduled" ${item.status === 'Rescheduled' ? 'selected' : ''}>Rescheduled</option>
                                </select>
                                <button class="update-button" data-id="${item.id}" data-collection="${collectionName}">
                                    Update
                                </button>
                                <span class="update-feedback" id="feedback-${item.id}" style="display: none;"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="data-card-content">
                        <div class="data-card-grid">
                            ${getCardContent(item, collectionName)}
                        </div>
                        
                        ${item.message || item.notes ? `
                            <div class="data-card-message">
                                <strong>Message/Notes:</strong>
                                <p>${item.message || item.notes}</p>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="data-card-footer">
                        <div class="footer-left">
                            <span class="data-created">Created: ${formatCreatedDate(item.createdAt)}</span>
                            <span class="data-type">${collectionName.charAt(0).toUpperCase() + collectionName.slice(1, -1)}</span>
                        </div>
                        <div class="footer-right">
                            <button class="export-single-btn" data-collection="${collectionName}" data-doc-id="${item.id}" data-format="xlsx" title="Export this ${collectionName.slice(0, -1)} to Excel">
                                üìä
                            </button>
                            <button class="export-single-btn" data-collection="${collectionName}" data-doc-id="${item.id}" data-format="csv" title="Export this ${collectionName.slice(0, -1)} to CSV">
                                üìÑ
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Get card subtitle based on collection type
        function getCardSubtitle(item, collectionName) {
            switch (collectionName) {
                case 'appointments':
                    return item.service || 'General Appointment';
                case 'visits':
                    return 'Center Visit Request';
                case 'callbacks':
                    return 'Callback Request';
                case 'consultations':
                    return item.consultationType || 'Free Consultation';
                default:
                    return '';
            }
        }
        
        // Get card content based on collection type
        function getCardContent(item, collectionName) {
            const baseContent = `
                <div class="data-field">
                    <label>üìû Phone:</label>
                    <span>${item.phone || 'Not provided'}</span>
                </div>
                <div class="data-field">
                    <label>üìß Email:</label>
                    <span>${item.email || 'Not provided'}</span>
                </div>
                <div class="data-field">
                    <label>üìÖ Date:</label>
                    <span>${item.date || item.formattedDate || 'Not specified'}</span>
                </div>
            `;
            
            let specificContent = '';
            
            switch (collectionName) {
                case 'appointments':
                    specificContent = `
                        <div class="data-field">
                            <label>üè• Service:</label>
                            <span>${item.service || 'Not specified'}</span>
                        </div>
                    `;
                    break;
                case 'visits':
                    specificContent = `
                        <div class="data-field">
                            <label>üè• Visit Type:</label>
                            <span>Center Visit</span>
                        </div>
                    `;
                    break;
                case 'callbacks':
                    specificContent = `
                        <div class="data-field">
                            <label>üìû Request Type:</label>
                            <span>Callback Request</span>
                        </div>
                    `;
                    break;
                case 'consultations':
                    specificContent = `
                        <div class="data-field">
                            <label>üí¨ Consultation:</label>
                            <span>${item.consultationType || 'Free Consultation'}</span>
                        </div>
                    `;
                    break;
            }
            
            return baseContent + specificContent;
        }
        
        // Format created date
        function formatCreatedDate(timestamp) {
            if (!timestamp) return 'Unknown';
            
            let date;
            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else if (timestamp instanceof Date) {
                date = timestamp;
            } else {
                date = new Date(timestamp);
            }
            
            return date.toLocaleString();
        }
        
        // Add status update listeners (now only for Update button clicks)
        function addStatusUpdateListeners(collectionName) {
            console.log(`üî• Setting up Update button listeners for ${collectionName}`);
            
            // Add click event listeners to all Update buttons for this collection
            const updateButtons = document.querySelectorAll(`[data-collection="${collectionName}"] .update-button`);
            
            console.log(`üî• Found ${updateButtons.length} Update buttons for ${collectionName}`);
            
            updateButtons.forEach(button => {
                button.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const itemId = button.dataset.id;
                    const collection = button.dataset.collection;
                    
                    console.log(`üî• Update button clicked for ${collection}/${itemId}`);
                    
                    await updateItemStatusWithFeedback(itemId, collection);
                });
            });
        }
        
        // Update item status in Firestore
        async function updateItemStatus(itemId, collectionName, newStatus) {
            try {
                console.log(`üîÑ Updating ${collectionName}/${itemId} status to: ${newStatus}`);
                
                const itemRef = doc(db, collectionName, itemId);
                await updateDoc(itemRef, {
                    status: newStatus,
                    lastModified: serverTimestamp(),
                    modifiedBy: auth.currentUser?.email || 'admin'
                });
                
                console.log(`‚úÖ Status updated successfully`);
                
                // Show success feedback
                showStatusUpdateFeedback(`Status updated to ${newStatus}`, 'success');
                
            } catch (error) {
                console.error('‚ùå Error updating status:', error);
                showStatusUpdateFeedback(`Error updating status: ${error.message}`, 'error');
                
                // Revert the select value
                const select = document.querySelector(`[data-id="${itemId}"][data-collection="${collectionName}"]`);
                if (select) {
                    // Find the original status and revert
                    const originalData = getCurrentCollectionData(collectionName).find(item => item.id === itemId);
                    if (originalData) {
                        select.value = originalData.status || 'Pending';
                    }
                }
            }
        }
        
        // Update item status with user feedback (called by Update button)
        async function updateItemStatusWithFeedback(itemId, collectionName) {
            console.log('üî• UPDATE BUTTON CLICKED:', itemId, collectionName);
            
            const selectElement = document.getElementById(`status-${itemId}`);
            const feedbackElement = document.getElementById(`feedback-${itemId}`);
            const updateButton = document.querySelector(`[data-id="${itemId}"].update-button`);
            
            console.log('üî• Elements found:', {
                selectElement: !!selectElement,
                feedbackElement: !!feedbackElement,
                updateButton: !!updateButton
            });
            
            if (!selectElement) {
                console.error('‚ùå Status select element not found for ID:', itemId);
                return;
            }
            
            const newStatus = selectElement.value;
            const originalData = getCurrentCollectionData(collectionName).find(item => item.id === itemId);
            const currentStatus = originalData?.status || 'Pending';
            
            console.log('üî• Status change:', { currentStatus, newStatus });
            
            // Check if status actually changed
            if (newStatus === currentStatus) {
                console.log('üî• No status change detected');
                showItemFeedback(feedbackElement, 'No change in status', 'info');
                return;
            }
            
            // Disable button and show loading
            if (updateButton) {
                updateButton.disabled = true;
                updateButton.textContent = 'Updating...';
            }
            
            try {
                console.log(`üîÑ Updating ${collectionName}/${itemId} status from "${currentStatus}" to "${newStatus}"`);
                
                const itemRef = doc(db, collectionName, itemId);
                await updateDoc(itemRef, {
                    status: newStatus,
                    lastModified: serverTimestamp(),
                    modifiedBy: auth.currentUser?.email || 'admin'
                });
                
                console.log(`‚úÖ Status updated successfully`);
                
                // Show success feedback
                showItemFeedback(feedbackElement, `Status updated to ${newStatus}`, 'success');
                
            } catch (error) {
                console.error('‚ùå Error updating status:', error);
                
                // Show error feedback
                showItemFeedback(feedbackElement, `Error: ${error.message}`, 'error');
                
                // Revert the select value
                selectElement.value = currentStatus;
                
            } finally {
                // Re-enable button
                if (updateButton) {
                    updateButton.disabled = false;
                    updateButton.textContent = 'Update';
                }
            }
        }
        
        // Show feedback for individual item updates
        function showItemFeedback(feedbackElement, message, type) {
            if (!feedbackElement) return;
            
            feedbackElement.textContent = message;
            feedbackElement.className = `update-feedback ${type}`;
            feedbackElement.style.display = 'inline-block';
            
            // Hide feedback after 3 seconds
            setTimeout(() => {
                feedbackElement.style.display = 'none';
            }, 3000);
        }
        
        // Get current collection data
        function getCurrentCollectionData(collectionName) {
            switch (collectionName) {
                case 'appointments': return currentAppointments;
                case 'visits': return currentVisits;
                case 'callbacks': return currentCallbacks;
                case 'consultations': return currentConsultations;
                default: return [];
            }
        }
        
        // Show status update feedback
        function showStatusUpdateFeedback(message, type) {
            // Create or update feedback element
            let feedback = document.getElementById('statusFeedback');
            if (!feedback) {
                feedback = document.createElement('div');
                feedback.id = 'statusFeedback';
                feedback.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 500;
                    z-index: 1000;
                    transition: opacity 0.3s ease;
                `;
                document.body.appendChild(feedback);
            }
            
            feedback.textContent = message;
            feedback.className = type === 'success' ? 'update-success' : 'update-error';
            feedback.style.backgroundColor = type === 'success' ? '#10b981' : '#ef4444';
            feedback.style.opacity = '1';
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                feedback.style.opacity = '0';
                setTimeout(() => {
                    if (feedback.parentNode) {
                        feedback.parentNode.removeChild(feedback);
                    }
                }, 300);
            }, 3000);
        }
        
        // Render appointments to the DOM (Legacy compatibility)
        function renderAppointments(appointments) {
            // Update global statistics (now includes all collections)
            updateStatistics();
            
            // Update export button states
            updateExportButtonStates(appointments);
            
            // Use the new universal rendering system
            const appointmentsList = document.getElementById('appointmentsList');
            if (appointmentsList) {
                renderCollectionData('appointments', appointments, appointmentsList);
                // Add status update listeners after rendering
                setTimeout(() => addStatusUpdateListeners('appointments'), 100);
            }
            
            // Also render to legacy container for compatibility
            const appointmentsContainer = document.getElementById('appointmentsContainer');
            if (appointmentsContainer) {
                appointmentsContainer.style.display = 'none'; // Hide legacy container
            }
        }
        
        // Format service name for display
        function formatServiceName(serviceId) {
            if (!serviceId) return 'N/A';
            
            const serviceMap = {
                'physical-therapy': 'Physical Therapy',
                'occupational-therapy': 'Occupational Therapy',
                'sports-rehabilitation': 'Sports Rehabilitation',
                'neurological-rehabilitation': 'Neurological Rehabilitation',
                'pain-management': 'Pain Management',
                'cardiac-rehabilitation': 'Cardiac Rehabilitation',
                'neuro-rehabilitation': 'Neuro Rehabilitation',
                'stroke-physiotherapy': 'Stroke Physiotherapy',
                'orthopedic-physiotherapy': 'Orthopedic Physiotherapy',
                'post-surgery-physiotherapy': 'Post Surgery Physiotherapy',
                'cardio-respiratory-physiotherapy': 'Cardio Respiratory Physiotherapy',
                'long-term-acute-care': 'Long Term Acute Care',
                'tracheostomy-care': 'Tracheostomy Care',
                'speech-therapy': 'Speech Therapy',
                'respiratory-therapy': 'Respiratory Therapy',
                'geriatric-care': 'Geriatric Care',
                'elderly-care': 'Elderly Care'
            };
            
            return serviceMap[serviceId] || serviceId;
        }
        
        // Update statistics cards
        // Update statistics with dynamic data from all collections
        function updateStatistics(appointments = []) {
            console.log('üìä Updating statistics with dynamic Firebase data...');
            
            // Get all collection data
            const allAppointments = currentAppointments || [];
            const allVisits = currentVisits || [];
            const allCallbacks = currentCallbacks || [];
            const allConsultations = currentConsultations || [];
            
            // Combine all data for comprehensive statistics
            const allData = [
                ...allAppointments.map(item => ({...item, type: 'appointment'})),
                ...allVisits.map(item => ({...item, type: 'visit'})),
                ...allCallbacks.map(item => ({...item, type: 'callback'})),
                ...allConsultations.map(item => ({...item, type: 'consultation'}))
            ];
            
            console.log('üìä Total data points:', allData.length);
            console.log('üìä Breakdown:', {
                appointments: allAppointments.length,
                visits: allVisits.length,
                callbacks: allCallbacks.length,
                consultations: allConsultations.length
            });
            
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // Calculate statistics from all collections
            const totalCount = allData.length;
            
            const todayCount = allData.filter(item => {
                if (!item.date) return false;
                try {
                    // Handle different date formats
                    let itemDate;
                    if (item.createdAt && item.createdAt.toDate) {
                        // Firestore timestamp
                        itemDate = item.createdAt.toDate();
                    } else if (item.date) {
                        itemDate = new Date(item.date);
                    } else {
                        return false;
                    }
                    return itemDate.toDateString() === today.toDateString();
                } catch (error) {
                    console.warn('Date parsing error for item:', item);
                    return false;
                }
            }).length;
            
            const monthCount = allData.filter(item => {
                if (!item.date && !item.createdAt) return false;
                try {
                    let itemDate;
                    if (item.createdAt && item.createdAt.toDate) {
                        itemDate = item.createdAt.toDate();
                    } else if (item.date) {
                        itemDate = new Date(item.date);
                    } else {
                        return false;
                    }
                    return itemDate.getMonth() === currentMonth && itemDate.getFullYear() === currentYear;
                } catch (error) {
                    console.warn('Date parsing error for item:', item);
                    return false;
                }
            }).length;
            
            const pendingCount = allData.filter(item => 
                (item.status || 'pending').toLowerCase() === 'pending'
            ).length;
            
            console.log('üìä Calculated statistics:', {
                total: totalCount,
                today: todayCount,
                month: monthCount,
                pending: pendingCount
            });
            
            // Update DOM elements with animation
            animateStatisticUpdate('totalAppointments', totalCount);
            animateStatisticUpdate('todayAppointments', todayCount);
            animateStatisticUpdate('monthAppointments', monthCount);
            animateStatisticUpdate('pendingAppointments', pendingCount);
        }
        
        // Animate statistic updates for better UX
        function animateStatisticUpdate(elementId, newValue) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const currentValue = element.textContent;
            if (currentValue !== newValue.toString()) {
                // Add a subtle animation
                element.style.transform = 'scale(1.1)';
                element.style.transition = 'transform 0.2s ease';
                
                setTimeout(() => {
                    element.textContent = newValue;
                    element.style.transform = 'scale(1)';
                }, 100);
            } else {
                element.textContent = newValue;
            }
        }
        
        // Update export button states based on data availability
        function updateExportButtonStates(appointments) {
            const hasData = appointments && appointments.length > 0;
            
            const excelBtn = document.getElementById('exportAppointmentsExcel');
            const csvBtn = document.getElementById('exportAppointmentsCSV');
            
            if (excelBtn) {
                excelBtn.disabled = !hasData;
                if (!hasData) {
                    excelBtn.innerHTML = '<span class="icon">üìä</span> No Data';
                } else {
                    excelBtn.innerHTML = '<span class="icon">üìä</span> Download Excel';
                }
            }
            
            if (csvBtn) {
                csvBtn.disabled = !hasData;
                if (!hasData) {
                    csvBtn.innerHTML = '<span class="icon">üìÑ</span> No Data';
                } else {
                    csvBtn.innerHTML = '<span class="icon">üìÑ</span> Download CSV';
                }
            }
        }
        
        // ==============================================
        // COLLECTION-SPECIFIC EXPORT FUNCTIONALITY
        // ==============================================
        
        // Collection field mappings for human-friendly headers
        const collectionFieldMappings = {
            appointments: {
                'Name': item => item.name || 'N/A',
                'Phone': item => item.phone || 'N/A',
                'Email': item => item.email || 'N/A',
                'Service': item => formatServiceName(item.service) || 'N/A',
                'Date': item => item.date || 'N/A',
                'Status': item => item.status || 'Pending',
                'Notes': item => item.notes || item.message || 'N/A',
                'Created': item => formatCreatedDate(item.createdAt),
                'Source': item => item.formType || 'Website'
            },
            visits: {
                'Name': item => item.name || 'N/A',
                'Phone': item => item.phone || 'N/A',
                'Email': item => item.email || 'N/A',
                'Date': item => item.date || 'N/A',
                'Status': item => item.status || 'Pending',
                'Message': item => item.message || item.notes || 'N/A',
                'Created': item => formatCreatedDate(item.createdAt)
            },
            callbacks: {
                'Name': item => item.name || 'N/A',
                'Phone': item => item.phone || 'N/A',
                'Email': item => item.email || 'N/A',
                'Status': item => item.status || 'Pending',
                'Message': item => item.message || item.notes || 'N/A',
                'Created': item => formatCreatedDate(item.createdAt)
            },
            consultations: {
                'Name': item => item.name || 'N/A',
                'Phone': item => item.phone || 'N/A',
                'Email': item => item.email || 'N/A',
                'Consultation Type': item => item.consultationType || 'Free Consultation',
                'Status': item => item.status || 'Pending',
                'Message': item => item.message || item.notes || 'N/A',
                'Created': item => formatCreatedDate(item.createdAt)
            }
        };
        
        // Generate filename with collection name and timestamp
        function generateCollectionFilename(collectionName, format, docId = null) {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
            const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, ''); // HHMMSS
            
            if (docId) {
                // Single document export
                return `${collectionName}_${docId}_${dateStr}.${format}`;
            } else {
                // Collection export
                return `${collectionName}_${dateStr}_${timeStr}.${format}`;
            }
        }
        
        // Format data for export using collection-specific mappings
        function formatDataForExport(data, collectionName) {
            const mapping = collectionFieldMappings[collectionName];
            if (!mapping) {
                console.error('No field mapping found for collection:', collectionName);
                return [];
            }
            
            return data.map(item => {
                const formattedItem = {};
                Object.keys(mapping).forEach(header => {
                    formattedItem[header] = mapping[header](item);
                });
                return formattedItem;
            });
        }
        
        // Collection data fetching functions
        function fetchCollectionData(collectionName) {
            switch (collectionName) {
                case 'appointments':
                    return currentAppointments || [];
                case 'visits':
                    return currentVisits || [];
                case 'callbacks':
                    return currentCallbacks || [];
                case 'consultations':
                    return currentConsultations || [];
                default:
                    console.error('Unknown collection:', collectionName);
                    return [];
            }
        }
        
        // Fetch single document from collection
        async function fetchDoc(collectionName, docId) {
            try {
                const docRef = doc(db, collectionName, docId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    return { id: docSnap.id, ...docSnap.data() };
                } else {
                    console.error('Document not found:', docId);
                    return null;
                }
            } catch (error) {
                console.error('Error fetching document:', error);
                return null;
            }
        }
        
        // Generate Excel file for collection
        function generateExcel(data, filename) {
            try {
                if (typeof XLSX === 'undefined') {
                    showToast('Excel export library not loaded. Please refresh the page.', 'error');
                    return false;
                }
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(data);
                
                // Set column widths
                const columnWidths = data.length > 0 ? 
                    Object.keys(data[0]).map(() => ({ wch: 20 })) : [];
                ws['!cols'] = columnWidths;
                
                XLSX.utils.book_append_sheet(wb, ws, 'Data');
                XLSX.writeFile(wb, filename);
                
                showToast(`Excel file "${filename}" downloaded successfully!`, 'success');
                return true;
            } catch (error) {
                console.error('Excel generation error:', error);
                showToast('Failed to generate Excel file: ' + error.message, 'error');
                return false;
            }
        }
        
        // Generate CSV file for collection
        function generateCSV(data, filename) {
            try {
                if (data.length === 0) {
                    showToast('No data to export', 'warning');
                    return false;
                }
                
                const headers = Object.keys(data[0]);
                const csvHeaders = headers.join(',');
                
                const csvRows = data.map(row => {
                    return headers.map(header => {
                        const value = row[header] || '';
                        // Escape quotes and wrap in quotes if contains comma or quote
                        if (value.toString().includes(',') || value.toString().includes('"') || value.toString().includes('\n')) {
                            return `"${value.toString().replace(/"/g, '""')}"`;
                        }
                        return value;
                    }).join(',');
                });
                
                const csvContent = [csvHeaders, ...csvRows].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (navigator.msSaveBlob) {
                    navigator.msSaveBlob(blob, filename);
                } else {
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                }
                
                showToast(`CSV file "${filename}" downloaded successfully!`, 'success');
                return true;
            } catch (error) {
                console.error('CSV generation error:', error);
                showToast('Failed to generate CSV file: ' + error.message, 'error');
                return false;
            }
        }
        
        // Event delegation for export buttons
        document.addEventListener('click', async function(e) {
            // Collection export buttons
            if (e.target.closest('.export-btn')) {
                const button = e.target.closest('.export-btn');
                const collectionName = button.getAttribute('data-collection');
                const format = button.getAttribute('data-format');
                
                if (!collectionName || !format) {
                    console.error('Missing data attributes on export button');
                    return;
                }
                
                // Disable button during export
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '‚è≥ Exporting...';
                
                try {
                    // Get collection data
                    const rawData = fetchCollectionData(collectionName);
                    
                    if (rawData.length === 0) {
                        showToast(`No ${collectionName} data available to export`, 'warning');
                        return;
                    }
                    
                    // Format data for export
                    const exportData = formatDataForExport(rawData, collectionName);
                    const filename = generateCollectionFilename(collectionName, format);
                    
                    // Generate file
                    if (format === 'xlsx') {
                        generateExcel(exportData, filename);
                    } else if (format === 'csv') {
                        generateCSV(exportData, filename);
                    }
                    
                } catch (error) {
                    console.error('Export error:', error);
                    showToast('Export failed: ' + error.message, 'error');
                } finally {
                    // Re-enable button
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }
            
            // Single document export buttons
            if (e.target.closest('.export-single-btn')) {
                const button = e.target.closest('.export-single-btn');
                const docId = button.getAttribute('data-doc-id');
                const collectionName = button.getAttribute('data-collection');
                const format = button.getAttribute('data-format');
                
                if (!docId || !collectionName || !format) {
                    console.error('Missing data attributes on single export button');
                    return;
                }
                
                // Disable button during export
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '‚è≥ Exporting...';
                
                try {
                    // Fetch single document
                    const docData = await fetchDoc(collectionName, docId);
                    
                    if (!docData) {
                        showToast('Document not found or error fetching data', 'error');
                        return;
                    }
                    
                    // Format data for export (single item array)
                    const exportData = formatDataForExport([docData], collectionName);
                    const filename = generateCollectionFilename(collectionName, format, docId);
                    
                    // Generate file
                    if (format === 'xlsx') {
                        generateExcel(exportData, filename);
                    } else if (format === 'csv') {
                        generateCSV(exportData, filename);
                    }
                    
                } catch (error) {
                    console.error('Single export error:', error);
                    showToast('Export failed: ' + error.message, 'error');
                } finally {
                    // Re-enable button
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }
        });
        
        // Legacy function for backward compatibility
        function exportToExcel() {
            console.warn('Legacy exportToExcel called - redirecting to new system');
            const activeCollectionData = fetchCollectionData(activeCollection);
            if (activeCollectionData.length > 0) {
                const exportData = formatDataForExport(activeCollectionData, activeCollection);
                const filename = generateCollectionFilename(activeCollection, 'xlsx');
                generateExcel(exportData, filename);
            } else {
                showToast(`No ${activeCollection} data available`, 'warning');
            }
        }
        
        // Legacy function for backward compatibility
        function exportToCSV() {
            console.warn('Legacy exportToCSV called - redirecting to new system');
            const activeCollectionData = fetchCollectionData(activeCollection);
            if (activeCollectionData.length > 0) {
                const exportData = formatDataForExport(activeCollectionData, activeCollection);
                const filename = generateCollectionFilename(activeCollection, 'csv');
                generateCSV(exportData, filename);
            } else {
                showToast(`No ${activeCollection} data available`, 'warning');
            }
        }
        
        // Make legacy functions globally accessible
        window.exportToExcel = exportToExcel;
        window.exportToCSV = exportToCSV;
        
        // ==============================================
        // END EXPORT FUNCTIONALITY
        // ==============================================
                updateExportButtonStates([]);
                
        
        // Global logout handler (backup method)
        async function handleLogoutClick() {
            console.log('üîê Global logout handler called!');
            
            try {
                console.log('üîê Attempting Firebase signOut via global handler...');
                await signOut(auth);
                console.log('‚úÖ Global logout successful');
                
                // Clear storage and redirect
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = 'admin.html?force-login=true';
                
            } catch (error) {
                console.error('‚ùå Global logout error:', error);
                alert('Failed to sign out. Please try again.');
            }
        }
        
        // Make global logout function available
        window.handleLogoutClick = handleLogoutClick;
        
        // Test logout functionality
        function testLogout() {
            console.log('üß™ Testing logout functionality...');
            const logoutButton = document.getElementById('logoutButton');
            console.log('üß™ Logout button element:', logoutButton);
            
            if (logoutButton) {
                console.log('üß™ Logout button found, triggering click...');
                logoutButton.click();
            } else {
                console.error('üß™ Logout button not found!');
            }
        }
        
        // Make test function globally available
        window.testLogout = testLogout;
        
        // Handle logout
        function setupLogoutButton() {
            console.log('üîê Setting up logout button...');
            
            // Wait a moment for DOM to be ready, then try to find the button
            setTimeout(() => {
                const logoutButton = document.getElementById('logoutButton');
                console.log('üîê Looking for logout button...', logoutButton);
                
                if (!logoutButton) {
                    console.error('‚ùå Logout button not found! Checking all buttons...');
                    const allButtons = document.querySelectorAll('button');
                    console.log('üîç All buttons found:', allButtons);
                    return;
                }
                
                // Remove any existing event listeners by cloning the button
                const newLogoutButton = logoutButton.cloneNode(true);
                logoutButton.parentNode.replaceChild(newLogoutButton, logoutButton);
                
                newLogoutButton.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üîê Logout button clicked!');
                    
                    // Show loading state
                    const originalText = newLogoutButton.innerHTML;
                    newLogoutButton.innerHTML = '<span class="logout-icon">‚è≥</span> Signing Out...';
                    newLogoutButton.disabled = true;
                    
                    try {
                        console.log('üîê Attempting Firebase signOut...');
                        console.log('üîê Auth object:', auth);
                        console.log('üîê Current user before signOut:', auth.currentUser);
                        
                        await signOut(auth);
                        console.log('‚úÖ Firebase signOut successful');
                        console.log('üîê Current user after signOut:', auth.currentUser);
                        
                        // Clear any local storage or session data
                        localStorage.clear();
                        sessionStorage.clear();
                        
                        // Redirect to login page with force-login parameter after logout
                        console.log('üîê Redirecting to login page...');
                        window.location.href = 'admin.html?force-login=true';
                        
                    } catch (error) {
                        console.error('‚ùå Logout error:', error);
                        console.error('‚ùå Error details:', error.message, error.code);
                        
                        // Restore button state
                        newLogoutButton.innerHTML = originalText;
                        newLogoutButton.disabled = false;
                        
                        alert('Failed to sign out. Please try again. Error: ' + error.message);
                    }
                });
                
                console.log('‚úÖ Logout button event listener attached successfully');
            }, 100);
        }
        
        // Global debug functions
        window.testFirebaseConnection = async function() {
            const debugStatus = document.getElementById('debugStatus');
            debugStatus.textContent = 'Testing Firebase...';
            debugStatus.style.color = '#f59e0b';
            
            try {
                // Test Firebase connection by creating a test document
                const testDoc = {
                    test: true,
                    timestamp: serverTimestamp(),
                    message: 'Admin dashboard connection test'
                };
                
                const docRef = await addDoc(collection(db, 'test'), testDoc);
                console.log('Firebase test successful:', docRef.id);
                
                debugStatus.textContent = `‚úÖ Firebase Connected (${docRef.id})`;
                debugStatus.style.color = '#10b981';
                
                setTimeout(() => {
                    debugStatus.textContent = 'Ready';
                    debugStatus.style.color = '#6b7280';
                }, 3000);
                
            } catch (error) {
                console.error('Firebase test failed:', error);
                debugStatus.textContent = `‚ùå Firebase Error: ${error.message}`;
                debugStatus.style.color = '#ef4444';
            }
        };
        
        window.refreshAppointments = function() {
            const debugStatus = document.getElementById('debugStatus');
            debugStatus.textContent = 'Refreshing appointments...';
            debugStatus.style.color = '#3b82f6';
            
            // Re-setup the appointments listener
            setupAppointmentsListener();
            
            setTimeout(() => {
                debugStatus.textContent = 'Data refreshed';
                debugStatus.style.color = '#10b981';
                
                setTimeout(() => {
                    debugStatus.textContent = 'Ready';
                    debugStatus.style.color = '#6b7280';
                }, 2000);
            }, 1000);
        };
        
        window.showDebugInfo = function() {
            const debugStatus = document.getElementById('debugStatus');
            const info = {
                totalAppointments: currentAppointments.length,
                listenerActive: !!unsubscribeFromAppointments,
                selectedDate: selectedDate ? selectedDate.toISOString() : null,
                currentDate: currentDate.toISOString(),
                authUser: auth.currentUser ? auth.currentUser.email : null
            };
            
            console.log('üêõ Debug Info:', info);
            console.log('üóÇÔ∏è Current Appointments:', currentAppointments);
            
            debugStatus.textContent = `Debug info logged (${info.totalAppointments} appointments)`;
            debugStatus.style.color = '#f59e0b';
            
            setTimeout(() => {
                debugStatus.textContent = 'Ready';
                debugStatus.style.color = '#6b7280';
            }, 3000);
        };
        
        // Status update functionality
        window.updateAppointmentStatus = async function(appointmentId) {
            const dropdown = document.getElementById(`status-${appointmentId}`);
            const feedback = document.getElementById(`feedback-${appointmentId}`);
            const updateButton = dropdown.parentNode.querySelector('.update-button');
            
            if (!dropdown || !feedback) {
                console.error('Status update elements not found for appointment:', appointmentId);
                return;
            }
            
            const newStatus = dropdown.value;
            const originalStatus = currentAppointments.find(app => app.id === appointmentId)?.status || 'Pending';
            
            // Don't update if status hasn't changed
            if (newStatus === originalStatus) {
                showStatusFeedback(feedback, 'No changes made', 'info');
                return;
            }
            
            // Show loading state
            updateButton.disabled = true;
            updateButton.textContent = 'Updating...';
            showStatusFeedback(feedback, 'Updating status...', 'loading');
            
            try {
                console.log(`üîÑ Updating appointment ${appointmentId} status from "${originalStatus}" to "${newStatus}"`);
                
                // Import updateDoc from Firebase
                const { updateDoc, doc } = await import('./firebase.js');
                
                // Create document reference
                const appointmentRef = doc(db, 'appointments', appointmentId);
                
                // Update the status in Firestore
                await updateDoc(appointmentRef, {
                    status: newStatus,
                    lastModified: serverTimestamp(),
                    modifiedBy: auth.currentUser?.email || 'admin'
                });
                
                console.log(`‚úÖ Successfully updated appointment ${appointmentId} status to "${newStatus}"`);
                
                // Update local data
                const appointmentIndex = currentAppointments.findIndex(app => app.id === appointmentId);
                if (appointmentIndex !== -1) {
                    currentAppointments[appointmentIndex].status = newStatus;
                }
                
                // Show success feedback
                showStatusFeedback(feedback, 'Status updated!', 'success');
                
                // The UI will automatically update via the onSnapshot listener
                // But we can also manually update the status badge for immediate feedback
                updateStatusBadgeInUI(appointmentId, newStatus);
                
            } catch (error) {
                console.error('‚ùå Error updating appointment status:', error);
                
                // Revert dropdown to original status
                dropdown.value = originalStatus;
                
                // Show error feedback
                let errorMessage = 'Failed to update status';
                if (error.code === 'permission-denied') {
                    errorMessage = 'Permission denied - check Firestore rules';
                } else if (error.code === 'not-found') {
                    errorMessage = 'Appointment not found';
                }
                
                showStatusFeedback(feedback, errorMessage, 'error');
                
            } finally {
                // Reset button state
                updateButton.disabled = false;
                updateButton.textContent = 'Update';
            }
        };
        
        // Helper function to show status feedback
        function showStatusFeedback(feedbackElement, message, type) {
            feedbackElement.textContent = message;
            feedbackElement.style.display = 'inline-block';
            
            // Remove existing classes
            feedbackElement.classList.remove('update-success', 'update-error', 'update-loading');
            
            // Add appropriate class
            if (type === 'success') {
                feedbackElement.classList.add('update-success');
            } else if (type === 'error') {
                feedbackElement.classList.add('update-error');
            } else if (type === 'loading') {
                feedbackElement.style.color = '#f59e0b';
            } else {
                feedbackElement.style.color = '#6b7280';
            }
            
            // Hide feedback after 3 seconds (except for loading)
            if (type !== 'loading') {
                setTimeout(() => {
                    feedbackElement.style.display = 'none';
                }, 3000);
            }
        }
        
        // Helper function to update status badge in UI immediately
        function updateStatusBadgeInUI(appointmentId, newStatus) {
            const appointmentCards = document.querySelectorAll('.appointment-card');
            
            appointmentCards.forEach(card => {
                const statusDropdown = card.querySelector(`#status-${appointmentId}`);
                if (statusDropdown) {
                    const statusBadge = card.querySelector('.status-badge');
                    if (statusBadge) {
                        // Update badge text
                        statusBadge.textContent = newStatus;
                        
                        // Update badge classes
                        statusBadge.className = `status-badge status-${newStatus.toLowerCase()}`;
                        
                        console.log(`üé® Updated status badge for appointment ${appointmentId} to "${newStatus}"`);
                    }
                }
            });
        }
    </script>
</body>
</html>
